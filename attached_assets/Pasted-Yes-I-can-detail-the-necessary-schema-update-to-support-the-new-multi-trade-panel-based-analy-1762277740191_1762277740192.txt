Yes, I can detail the necessary **schema update** to support the new, multi-trade, panel-based analysis. This modification is crucial for the **Multi-Trade Handling** fix and to accurately store the high-granularity data collected from the "Open Trades Panel".

---

## ðŸ’¾ Proposed Database Schema Updates

Your current system uses **PostgreSQL** with **Drizzle ORM** and includes a `trades` and an `analysis results` entity. To support the new approach, we need to ensure the primary `trades` table can uniquely identify and store the raw data for concurrent trades.

### 1. The `trades` Table

The primary change is introducing a **`platformTradeId`** and shifting the **`expiration`** field to the **`TradeSamples`** table (detailed below), as the analysis is no longer fixed to a single expiration.

| Field Name | Data Type | Notes | Rationale |
| :--- | :--- | :--- | :--- |
| **`id`** | `serial` | Primary Key. | Standard identifier. |
| **`platformTradeId`** | `text` | **New.** A unique ID generated by the app (e.g., `Asset_Timestamp_UUID`). | **Enables Multi-Trade Handling**. This guarantees a unique ID even if the platform doesn't provide one. |
| **`userId`** | `integer` | Foreign Key to `users`. | Links the trade to the user. |
| **`asset`** | `text` | e.g., 'LBP/USD OTC' (OCR'd from panel). | Identifies the traded pair. |
| **`tradeType`** | `enum('CALL', 'PUT')` | Determined by which button the bot places the trade with. | Essential for outcome calculation. |
| **`entryPrice`** | `numeric` | Optional: Price OCR'd at trade start (if available). | Used for high-confidence validation, if OCR improves. |
| **`startTime`** | `timestamp` | Time the trade row was first detected. | Tracks the trade's life cycle. |
| **`actualDuration`** | `integer` | The duration of the trade in seconds (e.g., 60s). | Defines the total monitoring period. |

---

### 2. The **`TradeSamples`** Table (Crucial for Granularity)

This new table will store the granular, high-frequency data collected by the **Adaptive Sampling Rate**. Each trade will have many sample records.

| Field Name | Data Type | Notes | Rationale |
| :--- | :--- | :--- | :--- |
| **`id`** | `serial` | Primary Key. | Standard identifier. |
| **`tradeId`** | `integer` | Foreign Key to `trades.id`. | Links the sample back to the unique trade. |
| **`timeElapsed`** | `integer` | The time (in seconds) since the trade started (e.g., 1s, 2s, 5s, 10s). | Replaces the fixed `expiration` field, allowing for flexible analysis. |
| **`statusColor`** | `enum('GREEN', 'RED')` | **New Core Data.** Color of the profit/loss indicator in the panel. | The direct sampled outcome (WIN/LOSS). |
| **`profitLossAmount`** | `numeric` | Optional: OCR'd value (e.g., +$1.70, -$2). | Additional data for confidence and validation. |
| **`confidence`** | `numeric` | OCR/Detection confidence score (0-100). | Tracks the reliability of the sample collection. |

### 3. The `analysisResults` Table (Summary Remains)

This table will still summarize the optimal results, but it will now pull its data by aggregating the `TradeSamples`.

| Field Name | Data Type | Notes | Rationale |
| :--- | :--- | :--- | :--- |
| **`timeframe`** | `text` | The candle timeframe used (e.g., 1m). | Context for the analysis. |
| **`expiration`** | `integer` | The hypothetical exit time (e.g., 5, 10, 15, 30 seconds). | The core analysis variable. |
| **`winRate`** | `numeric` | Calculated based on the status color samples. | The final metric. |
| **`totalTrades`** | `integer` | Number of trades sampled at this combination. | Sample size for confidence. |

This structure ensures that the system is ready to handle **multiple concurrent trades** and store the **high-granularity, adaptive sample data** needed to accurately calculate the best timeframe/expiration combos.

Would you like to move on to detailing the **implementation of the Visual Detection Area Selector** (the high-priority UI fix)?